# 第13章 文件输入/输出核心知识梳理  


## 一、核心知识总结  
### （一）核心概念提炼  
1. **文件操作函数体系**：  
   - **生命周期**：`fopen()`打开/创建文件，`fclose()`关闭（异常时用`exit()`确保关闭）。  
   - **字符级读写**：`getc()`读单字符，`putc()`写单字符。  
   - **格式化读写**：`fprintf()`/`fscanf()`支持文件的格式化输入输出（类似控制台的`printf`/`scanf`）。  
   - **行级读写**：`fgets()`读一行到缓冲区，`fputs()`写字符串到文件。  
   - **定位与跳转**：`fseek()`移动文件指针，`ftell()`获取指针位置，`rewind()`复位到开头。  
   - **二进制读写**：`fread()`/`fwrite()`按字节块读写（适合图片、结构体等非文本数据）。  
   - **缓冲与错误**：`setvbuf()`配置缓冲模式，`fflush()`强制刷新；`ferror()`/`feof()`检测错误和结束。  

2. **文件模式与类型**：  
   - **模式分类**：文本模式（字符流，自动转换换行符）、二进制模式（原始字节，无转换）。  
   - **打开权限**：`r`（读）、`w`（写，清空）、`a`（追加），带`b`表示二进制，带`+`表示读写共存（如`r+`、`wb+`）。  

3. **缓冲机制**：  
   - **全缓冲**：数据满缓冲区才写入（默认用于磁盘文件，提升效率）。  
   - **行缓冲**：遇换行符或缓冲区满时写入（默认用于终端，如`stdout`）。  
   - **无缓冲**：数据立即写入（如`stderr`，或通过`setvbuf`设置）。  

4. **访问方式**：  
   - **顺序访问**：指针自动后移，按顺序读写（如逐字符读取）。  
   - **随机访问**：通过`fseek()`手动定位指针（如跳转到文件中间修改数据）。  


## 二、关键函数代码示例  
### 示例1：文本文件复制（`getc` + `putc`）  
```c
#include <stdio.h>
int main() {
    FILE *src, *dest;
    int ch;

    // 1. 打开文件：文本模式，源文件读，目标文件写
    src = fopen("source.txt", "r");  
    dest = fopen("dest.txt", "w");  
    if (!src || !dest) { // 检查打开失败
        printf("文件打开失败！\n");
        return 1;
    }

    // 2. 逐字符复制：直到读到EOF（文件结束符）
    while ((ch = getc(src)) != EOF) {  
        putc(ch, dest); // 将字符写入目标文件
    }

    // 3. 关闭文件（自动刷新缓冲区）
    fclose(src); 
    fclose(dest); 
    printf("文件复制完成！\n");
    return 0;
}
```  
**说明**：  
- 文本模式下，Windows的`\r\n`会被自动转换为`\n`（读）和反向转换（写），保证跨平台兼容性。  
- `getc`返回`int`而非`char`，避免`EOF`（-1）与字符`255`冲突。  


### 示例2：二进制文件读写（`fread` + `fwrite` + `fseek`）  
```c
#include <stdio.h>
struct User { // 定义二进制数据结构
    int id;
    char name[20];
};

int main() {
    FILE *fp;
    struct User user = {1001, "Bob"}, read_user;

    // 1. 二进制写模式：创建并写入数据
    fp = fopen("user.dat", "wb"); 
    fwrite(&user, sizeof(user), 1, fp); // 写1个结构体大小的数据
    fclose(fp);

    // 2. 二进制读模式：随机访问（跳转到开头）
    fp = fopen("user.dat", "rb"); 
    fseek(fp, 0, SEEK_SET); // 指针移到文件开头（也可直接用 rewind(fp)）
    fread(&read_user, sizeof(read_user), 1, fp); // 读数据到结构体
    printf("ID: %d, Name: %s\n", read_user.id, read_user.name);

    fclose(fp);
    return 0;
}
```  
**说明**：  
- `fread`/`fwrite`直接操作内存数据，适合存储结构体、数组等二进制内容。  
- `fseek`的第三个参数`SEEK_SET`表示从文件开头计算偏移（偏移量为0时回到开头）。  


## 三、对比表格  
### （一）文本模式 vs 二进制模式  
| **对比项**       | 文本模式                          | 二进制模式                        |
|------------------|-----------------------------------|-----------------------------------|
| **数据存储**     | 字符流，换行符自动转换（如`\r\n`→`\n`） | 原始字节，无转换                  |
| **适用场景**     | 文本文件（.txt、代码）            | 二进制文件（图片、视频、结构体）  |
| **关键函数**     | `fgetc`、`fputs`、`fscanf`        | `fread`、`fwrite`、`getc`（兼容） |
| **换行符处理**   | 读写时自动转换换行符（如Windows下的`\r\n`） | 直接读写原始字节（含`\r\n`）      |  


### （二）常用文件打开模式  
| **模式** | **权限**          | **文件存在时**   | **文件不存在时** | **模式类型** |
|----------|-------------------|------------------|------------------|--------------|
| `r`      | 只读（文本）      | 正常打开         | 报错             | 文本         |
| `rb`     | 只读（二进制）    | 正常打开         | 报错             | 二进制       |
| `w`      | 只写（文本）      | 清空内容         | 创建新文件       | 文本         |
| `wb`     | 只写（二进制）    | 清空内容         | 创建新文件       | 二进制       |
| `a`      | 追加（文本，写末尾） | 指针移到末尾     | 创建新文件       | 文本         |
| `ab`     | 追加（二进制，写末尾） | 指针移到末尾     | 创建新文件       | 二进制       |
| `r+`     | 读写（文本）      | 正常打开         | 报错             | 文本（更新） |
| `rb+`    | 读写（二进制）    | 正常打开         | 报错             | 二进制（更新）|
| `w+`     | 读写（文本）      | 清空内容         | 创建新文件       | 文本（更新） |
| `wb+`    | 读写（二进制）    | 清空内容         | 创建新文件       | 二进制（更新）|  


## 四、扩展知识点补充  
### （一）进阶文件操作  
1. **文件共享与冲突**：  
   同一文件可被多个`FILE*`流同时操作，但需通过`fseek`同步指针位置，避免读写冲突。  

2. **错误处理强化**：  
   - `ferror(fp)`：检测读写错误（如磁盘满、权限不足）。  
   - `feof(fp)`：检测文件结束（需与`ferror`配合，避免将错误误判为结束）。  
   - `clearerr(fp)`：清除错误或结束标志，恢复文件操作。  

3. **临时文件应用**：  
   使用`tmpfile()`创建临时文件（自动以`wb+`模式打开，程序结束后自动删除），适合存储临时数据。  

4. **跨平台二进制兼容**：  
   不同系统的**字节序**（大端/小端）可能导致二进制数据解析错误，需统一格式（如网络字节序）或显式转换。  


### （二）实践优化建议  
- **缓冲策略**：对频繁读写的大文件，用`setvbuf(fp, NULL, _IOFBF, 8192)`设置**全缓冲**（增大缓冲区提升效率）；对终端交互，保留**行缓冲**。  
- **资源泄漏防范**：始终检查`fopen`返回值，确保文件成功打开；`fclose`失败时，调用`fflush`强制刷新缓冲区后重试。  


通过以上梳理，可系统掌握C语言文件IO的核心逻辑、函数差异及实践技巧，结合示例和对比表，清晰区分概念边界与应用场景。